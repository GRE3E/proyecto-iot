#include <Wire.h>

// === Pines de luces ===
const int ledPasilloEx = 2;
const int ledPasilloInt = 3;
const int ledSala = 4;
const int ledGaraje = 5;
const int ledHabInv = 6;
const int ledBaInv = 7;
const int ledHabP = 8;
const int ledBaP = 9;
const int ledLav = 10;
const int ledCocina = 11;
const int ledGarajeEx = 12;

struct Luz {
  const char* nombre; // Nombres como "LIGHT_1", "LIGHT_2", etc.
  int pin;
  bool estado;
};

Luz luces[] = {
  {"LIGHT_1", ledPasilloEx, false},
  {"LIGHT_2", ledPasilloInt, false},
  {"LIGHT_3", ledSala, false},
  {"LIGHT_4", ledGaraje, false},
  {"LIGHT_5", ledHabInv, false},
  {"LIGHT_6", ledBaInv, false},
  {"LIGHT_7", ledHabP, false},
  {"LIGHT_8", ledBaP, false},
  {"LIGHT_9", ledLav, false},
  {"LIGHT_10", ledCocina, false},
  {"LIGHT_11", ledGarajeEx, false}
};

String ultimaRespuesta = "";

void setup() {
  Wire.begin(8); // ID del esclavo
  Wire.onReceive(receiveEvent);
  Wire.onRequest(requestEvent);

  for (int i = 0; i < sizeof(luces) / sizeof(luces[0]); i++) {
    pinMode(luces[i].pin, OUTPUT);
    digitalWrite(luces[i].pin, LOW); // Asegura que todas las luces estén apagadas al inicio
  }

  Serial.begin(9600);
  Serial.println("Esclavo 1 listo (ID=8)");
}

void loop() {
  // Nada que hacer en loop, todo se maneja por interrupciones I2C
}

void receiveEvent(int howMany) {
  String comando = "";
  while (Wire.available()) {
    char c = Wire.read();
    if (c >= 32 && c <= 126) { // Filtrar caracteres imprimibles
      comando += c;
    }
  }
  comando.trim();
  comando.toUpperCase();

  Serial.print("Esclavo 1 recibio: ");
  Serial.println(comando);

  int espacio = comando.indexOf(' ');
  if (espacio == -1) {
    ultimaRespuesta = "INVALID_COMMAND";
    return;
  }

  String deviceTypeIndex = comando.substring(0, espacio);
  String accion = comando.substring(espacio + 1);

  bool foundLight = false;
  for (int i = 0; i < sizeof(luces) / sizeof(luces[0]); i++) {
    if (deviceTypeIndex == luces[i].nombre) {
      foundLight = true;
      if (accion == "ON") {
        if (luces[i].estado) {
          ultimaRespuesta = String(luces[i].nombre) + ":ALREADY_ON";
        } else {
          digitalWrite(luces[i].pin, HIGH);
          luces[i].estado = true;
          ultimaRespuesta = String(luces[i].nombre) + ":ON";
        }
      } else if (accion == "OFF") {
        if (!luces[i].estado) {
          ultimaRespuesta = String(luces[i].nombre) + ":ALREADY_OFF";
        } else {
          digitalWrite(luces[i].pin, LOW);
          luces[i].estado = false;
          ultimaRespuesta = String(luces[i].nombre) + ":OFF";
        }
      } else if (accion == "STATUS") { // Nueva acción para reportar el estado actual
        if (luces[i].estado) {
          ultimaRespuesta = String(luces[i].nombre) + ":ON";
        } else {
          ultimaRespuesta = String(luces[i].nombre) + ":OFF";
        }
      } else {
        ultimaRespuesta = String(luces[i].nombre) + ":INVALID_ACTION";
      }
      break;
    }
  }

  if (!foundLight) {
    ultimaRespuesta = "UNKNOWN_DEVICE";
  }
}

void requestEvent() {
  Wire.write(ultimaRespuesta.c_str(), ultimaRespuesta.length());
}
