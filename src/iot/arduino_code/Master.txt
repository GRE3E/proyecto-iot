// ========================================
// ARDUINO MASTER
// ========================================
#include <Wire.h>

// Direcciones I2C
const int MASTER_ADDRESS = 1;
const int SLAVE_LUCES_ADDRESS = 8;
const int SLAVE_SENSORES_ADDRESS = 9;
const int SLAVE_PUERTAS_ADDRESS = 10;
const int WIFI_ADDRESS = 7;

String ultimaTemperatura = "";

struct DeviceMap {
  const char* name;
  int index;
};

const DeviceMap luces[] PROGMEM = {
  {"GARAJE", 0},
  {"PASILLO", 1},
  {"HABITACION_INVITADOS", 2},
  {"BANO_INVITADOS", 3},
  {"LAVANDERIA", 4},
  {"BANO_PRINCIPAL", 5},
  {"HABITACION_PRINCIPAL", 6},
  {"COCINA", 7},
  {"SALA", 8}
};

const DeviceMap puertas[] PROGMEM = {
  {"PRINCIPAL", 0},
  {"GARAJE", 1},
  {"PASILLO", 2},
  {"HABITACION_INVITADOS", 3},
  {"BANO_INVITADOS", 4},
  {"LAVANDERIA", 5},
  {"BANO_PRINCIPAL", 6},
  {"HABITACION_PRINCIPAL", 7}
};

String serialBuffer = "";
unsigned long ultimaLectura = 0;
const unsigned long intervaloLectura = 5000;

void consolePrint(const char* message) {
  Serial.println(message);
  
  // Enviar al módulo WiFi para publicar en MQTT
  Wire.beginTransmission(WIFI_ADDRESS);
  Wire.write("CONSOLE|MASTER|");
  Wire.write(message);
  Wire.endTransmission();
}

void consolePrint(String message) {
  Serial.println(message);
  
  // Enviar al módulo WiFi para publicar en MQTT
  Wire.beginTransmission(WIFI_ADDRESS);
  Wire.print(F("CONSOLE|MASTER|"));
  Wire.print(message);
  Wire.endTransmission();
}

void setup() {
  Serial.begin(115200);
  Wire.begin();
  Wire.setClock(100000);
  
  consolePrint(F("=== Arduino MASTER I2C ==="));
  consolePrint(F("Sistema de control domotico"));
  consolePrint(F("Comandos: 'encender luz SALA', 'abrir puerta PRINCIPAL', etc."));
  consolePrint(F("\nDispositivos disponibles:"));
  consolePrint(F("\nLuces:"));
  for (int i = 0; i < 9; i++) {
    DeviceMap currentLuz;
    memcpy_P(&currentLuz, &luces[i], sizeof(DeviceMap));
    Serial.print(F("  - "));
    Serial.println(currentLuz.name);
  }
  consolePrint(F("\nPuertas:"));
  for (int i = 0; i < 8; i++) {
    DeviceMap currentPuerta;
    memcpy_P(&currentPuerta, &puertas[i], sizeof(DeviceMap));
    Serial.print(F("  - "));
    Serial.println(currentPuerta.name);
  }
  consolePrint(F("\nActuadores:"));
  consolePrint(F("  - VENTILADOR"));
  consolePrint(F("\nSistema listo\n"));
}

void loop() {
  leerSerial();
  if (millis() - ultimaLectura >= intervaloLectura) {
    ultimaLectura = millis();
    leerYEnviarEstados();
  }
}

void leerSerial() {
  while (Serial.available()) {
    char c = Serial.read();
    if (c == '\n' || c == '\r') {
      if (serialBuffer.length() > 0) {
        procesarComando(serialBuffer);
        serialBuffer = "";
      }
    } else if (serialBuffer.length() < 100) {
      serialBuffer += c;
    }
  }
}

void requestEvent() {
  // Si hay datos de temperatura disponibles, enviarlos
  if (ultimaTemperatura.length() > 0) {
    Wire.write(ultimaTemperatura.c_str());
    ultimaTemperatura = ""; // Limpiar después de enviar
  }
}

int getLuzIndex(String nombre) {
  for (int i = 0; i < 9; i++) {
    DeviceMap currentLuz;
    memcpy_P(&currentLuz, &luces[i], sizeof(DeviceMap));
    if (nombre == String(currentLuz.name)) return currentLuz.index;
  }
  return -1;
}

int getPuertaIndex(String nombre) {
  for (int i = 0; i < 8; i++) {
    DeviceMap currentPuerta;
    memcpy_P(&currentPuerta, &puertas[i], sizeof(DeviceMap));
    if (nombre == String(currentPuerta.name)) return currentPuerta.index;
  }
  return -1;
}

String getLuzName(int index) {
  if (index >= 0 && index < 9) {
    DeviceMap currentLuz;
    memcpy_P(&currentLuz, &luces[index], sizeof(DeviceMap));
    return String(currentLuz.name);
  }
  return "DESCONOCIDA";
}

String getPuertaName(int index) {
  if (index >= 0 && index < 8) {
    DeviceMap currentPuerta;
    memcpy_P(&currentPuerta, &puertas[index], sizeof(DeviceMap));
    return String(currentPuerta.name);
  }
  return "DESCONOCIDA";
}

void solicitarTemperatura() {
  Wire.beginTransmission(SLAVE_SENSORES_ADDRESS);
  Wire.print(F("TEMP"));
  Wire.endTransmission();
  
  delay(100); // Dar tiempo al esclavo para preparar la respuesta
  
  Wire.requestFrom(SLAVE_SENSORES_ADDRESS, 32);
  char respuestaBuffer[33]; // 32 caracteres + null terminator
  int i = 0;
  while (Wire.available() && i < 32) {
    respuestaBuffer[i++] = Wire.read();
  }
  respuestaBuffer[i] = '\0'; // Null-terminate the string
  
  if (i > 0) {
    ultimaTemperatura = String(respuestaBuffer);
    consolePrint(String(F("Temperatura recibida: ")) + ultimaTemperatura);
  } else {
    consolePrint(F("Error al leer temperatura"));
  }
}

void procesarComando(String cmd) {
  cmd.trim();
  if (cmd.length() == 0) return;
  
  cmd.toUpperCase();
  char consoleBuffer[50];
  sprintf(consoleBuffer, "%s %s", F("[PROCESANDO]:"), cmd.c_str());
  consolePrint(consoleBuffer);
  
  if (cmd.indexOf(F("LUZ")) != -1 || cmd.indexOf(F("LIGHT")) != -1 || cmd.indexOf(F("LAMPARA")) != -1) {
    int luzIndex = getLuzIndex(cmd);
    
    if (luzIndex == -1) {
      consolePrint(F("[ERROR] Luz no encontrada"));
      return;
    }
    
    String accion = "";
    if (cmd.indexOf(F("ENCENDER")) != -1 || cmd.indexOf(F("ON")) != -1 || cmd.indexOf(F("PRENDER")) != -1 || cmd.indexOf(F("ACTIVAR")) != -1) {
      accion = F("ENCENDER");
    } else if (cmd.indexOf(F("APAGAR")) != -1 || cmd.indexOf(F("OFF")) != -1 || cmd.indexOf(F("DESACTIVAR")) != -1) {
      accion = F("APAGAR");
    } else {
      consolePrint(F("[ERROR] Accion no reconocida para luz"));
      return;
    }
    
    char comandoBuffer[20];
    sprintf(comandoBuffer, "%d_%s", luzIndex, accion.c_str());
    enviarComandoI2C(SLAVE_LUCES_ADDRESS, comandoBuffer);
    sprintf(consoleBuffer, "%s %s %s", F("[OK] Luz"), getLuzName(luzIndex), accion.c_str());
    consolePrint(consoleBuffer);
  }
  
  else if (cmd.indexOf(F("PUERTA")) != -1 || cmd.indexOf(F("DOOR")) != -1) {
    int puertaIndex = getPuertaIndex(cmd);
    
    if (puertaIndex == -1) {
      consolePrint(F("[ERROR] Puerta no encontrada"));
      return;
    }
    
    String accion = "";
    if (cmd.indexOf(F("ABRIR")) != -1 || cmd.indexOf(F("OPEN")) != -1 || cmd.indexOf(F("ACTIVAR")) != -1) {
      accion = F("ABRIR");
    } else if (cmd.indexOf(F("CERRAR")) != -1 || cmd.indexOf(F("CLOSE")) != -1 || cmd.indexOf(F("DESACTIVAR")) != -1) {
      accion = F("CERRAR");
    } else {
      consolePrint(F("[ERROR] Accion no reconocida para puerta"));
      return;
    }
    
    char comandoBuffer[20];
    sprintf(comandoBuffer, "%d_%s", puertaIndex, accion.c_str());
    enviarComandoI2C(SLAVE_PUERTAS_ADDRESS, comandoBuffer);
    sprintf(consoleBuffer, "%s %s %s", F("[OK] Puerta"), getPuertaName(puertaIndex), accion.c_str());
    consolePrint(consoleBuffer);
  }
  
  else if (cmd.indexOf(F("VENTILADOR")) != -1 || cmd.indexOf(F("FAN")) != -1 || cmd.indexOf(F("VENTILACION")) != -1 || cmd.indexOf(F("AIRE")) != -1) {
    String accion = "";
    if (cmd.indexOf(F("ENCENDER")) != -1 || cmd.indexOf(F("ON")) != -1 || cmd.indexOf(F("PRENDER")) != -1 || cmd.indexOf(F("ACTIVAR")) != -1) {
      accion = F("VENTILADOR_ENCENDER");
    } else if (cmd.indexOf(F("APAGAR")) != -1 || cmd.indexOf(F("OFF")) != -1 || cmd.indexOf(F("DESACTIVAR")) != -1) {
      accion = F("VENTILADOR_APAGAR");
    } else {
      consolePrint(F("[ERROR] Accion no reconocida para ventilador"));
      return;
    }
    
    enviarComandoI2C(SLAVE_SENSORES_ADDRESS, accion.c_str());
    sprintf(consoleBuffer, "%s %s", F("[OK]"), accion.c_str());
    consolePrint(consoleBuffer);
  }
  
  else if (cmd.indexOf(F("TEMPERATURA")) != -1 || cmd.indexOf(F("TEMP")) != -1) {
    consolePrint(F("[INFO] Solicitando temperatura..."));
    solicitarTemperatura();
  }
  
  else if (cmd.indexOf(F("STATUS")) != -1 || cmd.indexOf(F("ESTADO")) != -1) {
    consolePrint(F("[INFO] Consultando estados..."));
    leerYEnviarEstados();
  }
  
  else if (cmd.indexOf(F("HELP")) != -1 || cmd.indexOf(F("AYUDA")) != -1) {
    consolePrint(F("\n=== COMANDOS DISPONIBLES ==="));
    consolePrint(F("Luces: 'encender/apagar luz [NOMBRE]' "));
    consolePrint(F("Puertas: 'abrir/cerrar puerta [NOMBRE]' "));
    consolePrint(F("Ventilador: 'encender/apagar ventilador' "));
    consolePrint(F("Temperatura: 'temperatura' o 'temp' "));
    consolePrint(F("Estado: 'status' o 'estado' "));
    consolePrint(F("============================\n"));
  }
  
  else {
    consolePrint(F("[ERROR] Comando no entendido"));
    consolePrint(F("Escribe 'help' para ver comandos disponibles"));
  }
}

void enviarComandoI2C(int address, const char* comando) {
  Wire.beginTransmission(address);
  Wire.write(comando);
  byte error = Wire.endTransmission();
  
  if (error != 0) {
    consolePrint("[ERROR I2C] Slave " + String(address) + " (codigo: " + String(error) + ")");
  }
  delay(50);
}

void leerYEnviarEstados() {
  consolePrint("\n--- ESTADOS ACTUALES ---");
  
  Wire.requestFrom(SLAVE_LUCES_ADDRESS, 9);
  delay(50);
  int lucesRecibidas = 0;
  char estadoStr[4]; // "ON", "OFF", "\0"
  char msgBuffer[50];
  char stateMsgBuffer[60];
  for (int i = 0; i < 9 && Wire.available(); i++) {
    byte estado = Wire.read();
    strcpy(estadoStr, ((estado == '1') ? "ON" : "OFF"));
    sprintf(msgBuffer, "LIGHT|%s|%s", getLuzName(i), estadoStr);
    consolePrint(msgBuffer);
    sprintf(stateMsgBuffer, "STATE|%s", msgBuffer);
    Wire.beginTransmission(WIFI_ADDRESS);
    Wire.write(stateMsgBuffer);
    Wire.endTransmission();
    lucesRecibidas++;
  }
  if (lucesRecibidas == 0) {
    consolePrint(F("[ERROR] No se recibieron estados de luces"));
  }
  
  Wire.requestFrom(SLAVE_SENSORES_ADDRESS, 16);
  delay(50);
  char datosBuffer[17]; // 16 caracteres + null terminator
  int bytesRead = 0;
  while (Wire.available() && bytesRead < 16) {
    datosBuffer[bytesRead++] = (char)Wire.read();
  }
  datosBuffer[bytesRead] = '\0'; // Null-terminate the string
  
  if (bytesRead > 5) {
    // Buscar los delimitadores ','
    char* c1_ptr = strchr(datosBuffer, ',');
    if (c1_ptr == NULL) {
      consolePrint(F("[ERROR] Formato de datos de sensores incorrecto (c1)"));
      return;
    }
    *c1_ptr = '\0'; // Terminar la primera parte para obtener la temperatura
    char* c2_ptr = strchr(c1_ptr + 1, ',');
    if (c2_ptr == NULL) {
      consolePrint(F("[ERROR] Formato de datos de sensores incorrecto (c2)"));
      return;
    }
    *c2_ptr = '\0'; // Terminar la segunda parte para obtener la distancia

    char* temp_str = datosBuffer + 2; // Saltar "T:"
    char* dist_str = c1_ptr + 3; // Saltar ",D:"
    char* vent_str = c2_ptr + 3; // Saltar ",V:"
      
    sprintf(msgBuffer, "SENSOR|TEMPERATURA|%sC", temp_str);
    consolePrint(msgBuffer);
    sprintf(stateMsgBuffer, "STATE|%s", msgBuffer);
    Wire.beginTransmission(WIFI_ADDRESS);
    Wire.write(stateMsgBuffer);
    Wire.endTransmission();

    sprintf(msgBuffer, "SENSOR|DISTANCIA|%scm", dist_str);
    consolePrint(msgBuffer);
    sprintf(stateMsgBuffer, "STATE|%s", msgBuffer);
    Wire.beginTransmission(WIFI_ADDRESS);
    Wire.write(stateMsgBuffer);
    Wire.endTransmission();

    const char* estadoVent = (strcmp(vent_str, "1") == 0) ? "ON" : "OFF";
    sprintf(msgBuffer, "ACTUATOR|VENTILADOR|%s", estadoVent);
    consolePrint(msgBuffer);
    sprintf(stateMsgBuffer, "STATE|%s", msgBuffer);
    Wire.beginTransmission(WIFI_ADDRESS);
    Wire.write(stateMsgBuffer);
    Wire.endTransmission();

  } else {
    consolePrint(F("[ERROR] Datos de sensores incompletos"));
  }
  
  Wire.requestFrom(SLAVE_PUERTAS_ADDRESS, 8);
  delay(50);
  int puertasRecibidas = 0;
  for (int i = 0; i < 8 && Wire.available(); i++) {
    byte estado = Wire.read();
    String estadoStr = ((estado == '1') ? "OPEN" : "CLOSED");
    String msg = "DOOR|" + getPuertaName(i) + "|" + estadoStr;
    consolePrint(msg);
    Wire.beginTransmission(WIFI_ADDRESS);
    Wire.write(("STATE|" + msg).c_str());
    Wire.endTransmission();
    puertasRecibidas++;
  }
  if (puertasRecibidas == 0) {
    consolePrint("[ERROR] No se recibieron estados de puertas");
  }
  
  consolePrint("--- FIN ESTADOS ---\n");
}