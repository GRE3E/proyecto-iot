#include <Wire.h>
#include <ESP8266WiFi.h>
#include <PubSubClient.h>
#include <LiquidCrystal_I2C.h>

// === Configuración WiFi ===
const char* ssid = "YOUR_WIFI_SSID"; // Reemplaza con tu SSID
const char* password = "YOUR_WIFI_PASSWORD"; // Reemplaza con tu contraseña

// === Configuración MQTT ===
const char* mqtt_server = "YOUR_MQTT_BROKER_IP"; // Reemplaza con la IP de tu broker MQTT
const int mqtt_port = 1883; // Puerto MQTT estándar
const char* mqtt_client_id = "MasterDisplay"; // ID único para este cliente MQTT

WiFiClient espClient;
PubSubClient client(espClient);

// ---- Configuración LCD 16x2 ----
LiquidCrystal_I2C lcd(0x27, 16, 2);

// === Tópicos MQTT a los que suscribirse ===
const char* topic_luz1_estado = "iot/luces/luz_sala/estado";
const char* topic_luz2_estado = "iot/luces/luz_cocina/estado";
const char* topic_luz3_estado = "iot/luces/luz_dormitorio/estado";

const char* topic_aire_estado = "iot/hvac/aire_sala/estado";
const char* topic_temp_estado = "iot/sensores/temperatura_sala/estado";
const char* topic_ultrasonico_estado = "iot/sensores/ultrasonico_entrada/estado";

const char* topic_puerta_principal_estado = "iot/puertas/principal/estado";
const char* topic_puerta_garaje_estado = "iot/puertas/garaje/estado";

// Variables para almacenar los últimos estados y mostrarlos en el LCD
String estadoLuz1 = "DESCONOCIDO";
String estadoLuz2 = "DESCONOCIDO";
String estadoLuz3 = "DESCONOCIDO";
String estadoAire = "DESCONOCIDO";
String estadoTemp = "DESCONOCIDO";
String estadoDist = "DESCONOCIDO";
String estadoPuertaPrincipal = "DESCONOCIDO";
String estadoPuertaGaraje = "DESCONOCIDO";

// === Declaraciones de funciones ===
void setup_wifi();
void callback(char* topic, byte* payload, unsigned int length);
void reconnect();
void actualizarLCD();

void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("Conectando a ");
  Serial.println(ssid);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("");
  Serial.println("WiFi conectado");
  Serial.print("Dirección IP: ");
  Serial.println(WiFi.localIP());
}

void callback(char* topic, byte* payload, unsigned int length) {
  String mensaje = "";
  for (int i = 0; i < length; i++) {
    mensaje += (char)payload[i];
  }
  Serial.print("Mensaje MQTT recibido en ");
  Serial.print(topic);
  Serial.print(": ");
  Serial.println(mensaje);

  // Actualizar estados basados en el tópico
  if (strcmp(topic, topic_luz1_estado) == 0) {
    estadoLuz1 = mensaje;
  } else if (strcmp(topic, topic_luz2_estado) == 0) {
    estadoLuz2 = mensaje;
  } else if (strcmp(topic, topic_luz3_estado) == 0) {
    estadoLuz3 = mensaje;
  } else if (strcmp(topic, topic_aire_estado) == 0) {
    estadoAire = mensaje;
  } else if (strcmp(topic, topic_temp_estado) == 0) {
    estadoTemp = mensaje;
  } else if (strcmp(topic, topic_ultrasonico_estado) == 0) {
    estadoDist = mensaje;
  } else if (strcmp(topic, topic_puerta_principal_estado) == 0) {
    estadoPuertaPrincipal = mensaje;
  } else if (strcmp(topic, topic_puerta_garaje_estado) == 0) {
    estadoPuertaGaraje = mensaje;
  }
  actualizarLCD();
}

void reconnect() {
  while (!client.connected()) {
    Serial.print("Intentando conexión MQTT...");
    if (client.connect(mqtt_client_id)) {
      Serial.println("conectado");
      // Suscribirse a los tópicos de estado de los esclavos
      client.subscribe(topic_luz1_estado);
      client.subscribe(topic_luz2_estado);
      client.subscribe(topic_luz3_estado);
      client.subscribe(topic_aire_estado);
      client.subscribe(topic_temp_estado);
      client.subscribe(topic_ultrasonico_estado);
      client.subscribe(topic_puerta_principal_estado);
      client.subscribe(topic_puerta_garaje_estado);

      Serial.println("Suscrito a tópicos de estado.");
    } else {
      Serial.print("falló, rc=");
      Serial.print(client.state());
      Serial.println(" intentando de nuevo en 5 segundos");
      delay(5000);
    }
  }
}

void setup() {
  Serial.begin(115200); // Usar una velocidad de baudios más alta para ESP8266
  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);

  // ---- Inicializar LCD ----
  lcd.init();        // Inicializar LCD
  lcd.backlight();   // Encender luz de fondo
  lcd.setCursor(0, 0);
  lcd.print("Master MQTT");
  lcd.setCursor(0, 1);
  lcd.print("Iniciando...");

  Serial.println("Master Display listo (MQTT)");
}

void loop() {
  if (!client.connected()) {
    reconnect();
  }
  client.loop();
}

void actualizarLCD() {
  // Esta función se llamará cada vez que se reciba un mensaje MQTT
  // Podemos rotar la información o mostrar la más relevante.
  // Por simplicidad, mostraremos la temperatura y el estado de una luz/puerta.

  static int displayMode = 0;
  lcd.clear();

  switch (displayMode) {
    case 0:
      lcd.setCursor(0, 0);
      lcd.print("Temp: " + estadoTemp + " C");
      lcd.setCursor(0, 1);
      lcd.print("Aire: " + estadoAire);
      break;
    case 1:
      lcd.setCursor(0, 0);
      lcd.print("Luz Sala: " + estadoLuz1);
      lcd.setCursor(0, 1);
      lcd.print("Luz Cocina: " + estadoLuz2);
      break;
    case 2:
      lcd.setCursor(0, 0);
      lcd.print("Puerta Ppal: " + estadoPuertaPrincipal);
      lcd.setCursor(0, 1);
      lcd.print("Garaje: " + estadoPuertaGaraje);
      break;
    case 3:
      lcd.setCursor(0, 0);
      lcd.print("Distancia: " + estadoDist + " cm");
      lcd.setCursor(0, 1);
      lcd.print("Luz Dorm: " + estadoLuz3);
      break;
  }
  displayMode = (displayMode + 1) % 4; // Rotar entre 4 modos de visualización
}