// ========================================
// ARDUINO MASTER
// ========================================
#include <Wire.h>

#define SLAVE_LUCES_ADDRESS 8
#define SLAVE_SENSORES_ADDRESS 9
#define SLAVE_PUERTAS_ADDRESS 10

struct DeviceMap {
  String name;
  int index;
};

DeviceMap luces[] = {
  {"GARAJE", 0},
  {"PASILLO", 1},
  {"HABITACION_INVITADOS", 2},
  {"BANO_INVITADOS", 3},
  {"LAVANDERIA", 4},
  {"BANO_PRINCIPAL", 5},
  {"HABITACION_PRINCIPAL", 6},
  {"COCINA", 7},
  {"SALA", 8}
};

DeviceMap puertas[] = {
  {"PRINCIPAL", 0},
  {"GARAJE", 1},
  {"PASILLO", 2},
  {"HABITACION_INVITADOS", 3},
  {"BANO_INVITADOS", 4},
  {"LAVANDERIA", 5},
  {"BANO_PRINCIPAL", 6},
  {"HABITACION_PRINCIPAL", 7}
};

String serialBuffer = "";
unsigned long ultimaLectura = 0;
const unsigned long intervaloLectura = 5000;

void setup() {
  Serial.begin(115200);
  Wire.begin();
  Wire.setClock(100000);
  
  Serial.println("=== Arduino MASTER I2C ===");
  Serial.println("Sistema de control domotico");
  Serial.println("Comandos: 'encender luz SALA', 'abrir puerta PRINCIPAL', etc.");
  Serial.println("\nDispositivos disponibles:");
  Serial.println("\nLuces:");
  for (int i = 0; i < 9; i++) {
    Serial.println("  - " + luces[i].name);
  }
  Serial.println("\nPuertas:");
  for (int i = 0; i < 8; i++) {
    Serial.println("  - " + puertas[i].name);
  }
  Serial.println("\nActuadores:");
  Serial.println("  - VENTILADOR");
  Serial.println("\nSistema listo\n");
}

void loop() {
  leerSerial();
  if (millis() - ultimaLectura >= intervaloLectura) {
    ultimaLectura = millis();
    leerYEnviarEstados();
  }
}

void leerSerial() {
  while (Serial.available()) {
    char c = Serial.read();
    if (c == '\n' || c == '\r') {
      if (serialBuffer.length() > 0) {
        procesarComando(serialBuffer);
        serialBuffer = "";
      }
    } else if (serialBuffer.length() < 100) {
      serialBuffer += c;
    }
  }
}

int getLuzIndex(String nombre) {
  nombre.toUpperCase();
  for (int i = 0; i < 9; i++) {
    if (nombre.indexOf(luces[i].name) != -1) {
      return luces[i].index;
    }
  }
  return -1;
}

int getPuertaIndex(String nombre) {
  nombre.toUpperCase();
  for (int i = 0; i < 8; i++) {
    if (nombre.indexOf(puertas[i].name) != -1) {
      return puertas[i].index;
    }
  }
  return -1;
}

String getLuzName(int index) {
  if (index >= 0 && index < 9) return luces[index].name;
  return "DESCONOCIDA";
}

String getPuertaName(int index) {
  if (index >= 0 && index < 8) return puertas[index].name;
  return "DESCONOCIDA";
}

void procesarComando(String cmd) {
  cmd.trim();
  if (cmd.length() == 0) return;
  
  cmd.toUpperCase();
  
  Serial.println("\n[PROCESANDO]: " + cmd);
  
  if (cmd.indexOf("LUZ") != -1 || cmd.indexOf("LIGHT") != -1 || cmd.indexOf("LAMPARA") != -1) {
    int luzIndex = getLuzIndex(cmd);
    
    if (luzIndex == -1) {
      Serial.println("[ERROR] Luz no encontrada");
      return;
    }
    
    String accion = "";
    if (cmd.indexOf("ENCENDER") != -1 || cmd.indexOf("ON") != -1 || cmd.indexOf("PRENDER") != -1 || cmd.indexOf("ACTIVAR") != -1) {
      accion = "ENCENDER";
    } else if (cmd.indexOf("APAGAR") != -1 || cmd.indexOf("OFF") != -1 || cmd.indexOf("DESACTIVAR") != -1) {
      accion = "APAGAR";
    } else {
      Serial.println("[ERROR] Accion no reconocida para luz");
      return;
    }
    
    String comando = String(luzIndex) + "_" + accion;
    enviarComandoI2C(SLAVE_LUCES_ADDRESS, comando);
    Serial.println("[OK] Luz " + getLuzName(luzIndex) + " " + accion);
  }
  
  else if (cmd.indexOf("PUERTA") != -1 || cmd.indexOf("DOOR") != -1) {
    int puertaIndex = getPuertaIndex(cmd);
    
    if (puertaIndex == -1) {
      Serial.println("[ERROR] Puerta no encontrada");
      return;
    }
    
    String accion = "";
    if (cmd.indexOf("ABRIR") != -1 || cmd.indexOf("OPEN") != -1 || cmd.indexOf("ACTIVAR") != -1) {
      accion = "ABRIR";
    } else if (cmd.indexOf("CERRAR") != -1 || cmd.indexOf("CLOSE") != -1 || cmd.indexOf("DESACTIVAR") != -1) {
      accion = "CERRAR";
    } else {
      Serial.println("[ERROR] Accion no reconocida para puerta");
      return;
    }
    
    String comando = String(puertaIndex) + "_" + accion;
    enviarComandoI2C(SLAVE_PUERTAS_ADDRESS, comando);
    Serial.println("[OK] Puerta " + getPuertaName(puertaIndex) + " " + accion);
  }
  
  else if (cmd.indexOf("VENTILADOR") != -1 || cmd.indexOf("FAN") != -1 || cmd.indexOf("VENTILACION") != -1 || cmd.indexOf("AIRE") != -1) {
    String accion = "";
    if (cmd.indexOf("ENCENDER") != -1 || cmd.indexOf("ON") != -1 || cmd.indexOf("PRENDER") != -1 || cmd.indexOf("ACTIVAR") != -1) {
      accion = "VENTILADOR_ENCENDER";
    } else if (cmd.indexOf("APAGAR") != -1 || cmd.indexOf("OFF") != -1 || cmd.indexOf("DESACTIVAR") != -1) {
      accion = "VENTILADOR_APAGAR";
    } else {
      Serial.println("[ERROR] Accion no reconocida para ventilador");
      return;
    }
    
    enviarComandoI2C(SLAVE_SENSORES_ADDRESS, accion);
    Serial.println("[OK] " + accion);
  }
  
  else if (cmd.indexOf("STATUS") != -1 || cmd.indexOf("ESTADO") != -1) {
    Serial.println("[INFO] Consultando estados...");
    leerYEnviarEstados();
  }
  
  else if (cmd.indexOf("HELP") != -1 || cmd.indexOf("AYUDA") != -1) {
    Serial.println("\n=== COMANDOS DISPONIBLES ===");
    Serial.println("Luces: 'encender/apagar luz [NOMBRE]'");
    Serial.println("Puertas: 'abrir/cerrar puerta [NOMBRE]'");
    Serial.println("Ventilador: 'encender/apagar ventilador'");
    Serial.println("Estado: 'status' o 'estado'");
    Serial.println("============================\n");
  }
  
  else {
    Serial.println("[ERROR] Comando no entendido");
    Serial.println("Escribe 'help' para ver comandos disponibles");
  }
}

void enviarComandoI2C(int address, String comando) {
  Wire.beginTransmission(address);
  Wire.write((const uint8_t*)comando.c_str(), comando.length());
  byte error = Wire.endTransmission();
  
  if (error != 0) {
    Serial.println("[ERROR I2C] Slave " + String(address) + " (codigo: " + String(error) + ")");
  }
  delay(50);
}

void leerYEnviarEstados() {
  Serial.println("\n--- ESTADOS ACTUALES ---");
  
  // === LUCES ===
  Wire.requestFrom(SLAVE_LUCES_ADDRESS, 9);
  delay(50);
  int lucesRecibidas = 0;
  for (int i = 0; i < 9 && Wire.available(); i++) {
    byte estado = Wire.read();
    Serial.println("LIGHT|" + getLuzName(i) + "|" + ((estado == '1') ? "ON" : "OFF"));
    lucesRecibidas++;
  }
  if (lucesRecibidas == 0) {
    Serial.println("[ERROR] No se recibieron estados de luces");
  }
  
  // === SENSORES ===
  Wire.requestFrom(SLAVE_SENSORES_ADDRESS, 16);
  delay(50);
  String datos = "";
  while (Wire.available()) {
    datos += (char)Wire.read();
  }
  
  if (datos.length() > 5) {
    int c1 = datos.indexOf(',');
    int c2 = datos.indexOf(',', c1 + 1);
    
    if (c1 > 2 && c2 > c1 + 3 && c2 + 3 < datos.length()) {
      String temp = datos.substring(2, c1);
      String dist = datos.substring(c1 + 3, c2);
      String vent = datos.substring(c2 + 3);
      
      Serial.println("SENSOR|TEMPERATURA|" + temp + "C");
      Serial.println("SENSOR|DISTANCIA|" + dist + "cm");
      String estadoVent = (vent == "1") ? "ON" : "OFF";
      Serial.println("ACTUATOR|VENTILADOR|" + estadoVent);
    } else {
      Serial.println("[ERROR] Formato de datos de sensores invalido: " + datos);
    }
  } else {
    Serial.println("[ERROR] No se recibieron datos de sensores");
  }
  
  // === PUERTAS ===
  Wire.requestFrom(SLAVE_PUERTAS_ADDRESS, 8);
  delay(50);
  int puertasRecibidas = 0;
  for (int i = 0; i < 8 && Wire.available(); i++) {
    byte estado = Wire.read();
    Serial.println("DOOR|" + getPuertaName(i) + "|" + ((estado == '1') ? "OPEN" : "CLOSED"));
    puertasRecibidas++;
  }
  if (puertasRecibidas == 0) {
    Serial.println("[ERROR] No se recibieron estados de puertas");
  }
  
  Serial.println("--- FIN ESTADOS ---\n");
}