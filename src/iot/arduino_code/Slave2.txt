// ========================================
// ARDUINO ESCLAVO 2 - Sensores
// ========================================
#include <Wire.h>

#define SLAVE_ADDRESS 9
#define MAX_CMD_LENGTH 32

void consolePrint(const __FlashStringHelper* message) {
  Serial.println(message);
}

const int pinTemp = A0;
const int trig = 4;
const int echo = 3;
const int fan = 5;

float temperatura = 0.0;
long distancia = 0;
bool ventilador = false;

unsigned long ultimaLecturaSensor = 0;
const unsigned long intervaloSensor = 500;

void consolePrint(const char* message) {
  Serial.println(message);
}

void setup() {
  Serial.begin(115200);
  Wire.begin(SLAVE_ADDRESS);
  Wire.onRequest(requestEvent);
  Wire.onReceive(receiveEvent);
  
  pinMode(trig, OUTPUT);
  pinMode(echo, INPUT);
  pinMode(fan, OUTPUT);
  digitalWrite(trig, LOW);
  analogWrite(fan, 0);
  
  consolePrint(F("=== SLAVE 2 - Sensores y Actuadores ==="));
  consolePrint(F("Direccion I2C: 9"));
  consolePrint(F("Sensor temperatura: A0 (LM35)"));
  consolePrint(F("Sensor distancia: Trig=4, Echo=3 (HC-SR04)"));
  consolePrint(F("Ventilador: Pin 5 (PWM)"));
  consolePrint(F("Sistema listo"));
}

void loop() {
  if (millis() - ultimaLecturaSensor >= intervaloSensor) {
    ultimaLecturaSensor = millis();
    temperatura = leerTemp();
    distancia = leerDist();
    
    static unsigned long ultimoReporte = 0;
    if (millis() - ultimoReporte >= 5000) {
      ultimoReporte = millis();
      char consoleBuffer[60];
      consolePrint(F("--- Lecturas Actuales ---"));
      sprintf(consoleBuffer, "Temperatura: %.1fC", temperatura);
      consolePrint(consoleBuffer);
      sprintf(consoleBuffer, "Distancia: %ld cm", distancia);
      consolePrint(consoleBuffer);
      sprintf(consoleBuffer, "Ventilador: %s", ventilador ? "ON" : "OFF");
      consolePrint(consoleBuffer);
      consolePrint(F("------------------------"));
    }
  }
}

void receiveEvent(int howMany) {
  char cmd[MAX_CMD_LENGTH + 1];
  int i = 0;
  
  while (Wire.available() && i < MAX_CMD_LENGTH) {
    cmd[i++] = Wire.read();
  }
  cmd[i] = '\0'; // Null-terminate the string
  
  // Clear any remaining bytes in the buffer
  while (Wire.available()) {
    Wire.read();
  }
  
  // Convert to uppercase (in-place)
  for (int j = 0; cmd[j]; j++) {
    cmd[j] = toupper(cmd[j]);
  }
  
  char consoleBuffer[60];
  
  if (strcmp(cmd, "VENTILADOR_ENCENDER") == 0) {
    analogWrite(fan, 200);
    ventilador = true;
    consolePrint(F("Ventilador ENCENDIDO (PWM: 200/255)"));
  }
  else if (strcmp(cmd, "VENTILADOR_APAGAR") == 0) {
    analogWrite(fan, 0);
    ventilador = false;
    consolePrint(F("Ventilador APAGADO"));
  }
  else if (strcmp(cmd, "TEMP") == 0) {
    // No action needed here, requestEvent will handle sending temperature
  }
  else {
    sprintf(consoleBuffer, "ERROR: Comando no reconocido: %s", cmd);
    consolePrint(consoleBuffer);
    consolePrint(F("Comandos validos: VENTILADOR_ENCENDER, VENTILADOR_APAGAR, TEMP"));
  }
}

void requestEvent() {
  char data[20]; // Buffer para los datos a enviar
  
  int tempInt = (int)temperatura;
  int distInt = (int)distancia;
  if (distInt > 999) distInt = 999;
  if (distInt < 0) distInt = 0;
  
  sprintf(data, "T:%d,D:%d,V:%d", tempInt, distInt, ventilador ? 1 : 0);
  
  if (strlen(data) <= 16) {
    Wire.write(data);
    char consoleBuffer[50];
    sprintf(consoleBuffer, "Datos enviados: %s", data);
    consolePrint(consoleBuffer);
  } else {
    char fallback[20];
    sprintf(fallback, "T:%d,D:0,V:0", tempInt);
    Wire.write(fallback);
    char consoleBuffer[50];
    sprintf(consoleBuffer, "WARN: Datos truncados: %s", fallback);
    consolePrint(consoleBuffer);
  }
}

float leerTemp() {
  float suma = 0;
  for (int i = 0; i < 10; i++) {
    float v = analogRead(pinTemp) * (5.0 / 1023.0);
    suma += v * 100.0;
    delay(10);
  }
  return suma / 10.0;
}

long leerDist() {
  digitalWrite(trig, LOW);
  delayMicroseconds(2);
  digitalWrite(trig, HIGH);
  delayMicroseconds(10);
  digitalWrite(trig, LOW);
  
  long dur = pulseIn(echo, HIGH, 30000);
  if (dur == 0) {
    return -1;
  }
  return dur * 0.034 / 2;
}