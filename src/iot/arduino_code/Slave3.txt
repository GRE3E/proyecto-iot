// ========================================
// ESCLAVO 3 - PUERTAS
// ========================================
#include <Wire.h>
#include <Servo.h>

#define SLAVE_ADDRESS 10
#define MAX_CMD_LENGTH 32

Servo servos[8];
const int servoPins[8] = {2, 3, 4, 5, 6, 7, 8, 9};
bool estado[8] = {false};

const int ABIERTO = 90;
const int CERRADO = 0;

void consolePrint(const char* message) {
  Serial.println(message);
}

void setup() {
  Serial.begin(115200);
  Wire.begin(SLAVE_ADDRESS);
  Wire.onReceive(receiveEvent);
  Wire.onRequest(requestEvent);
  
  for (int i = 0; i < 8; i++) {
    servos[i].attach(servoPins[i]);
    servos[i].write(CERRADO);
    delay(100);
  }
  
  consolePrint(F("=== SLAVE 3 - Control de Puertas ==="));
  consolePrint(F("Direccion I2C: 10"));
  consolePrint(F("8 servomotores disponibles (0-7)"));
  consolePrint(F("0=PRINCIPAL, 1=GARAJE, 2=PASILLO, 3=H.INVITADOS"));
  consolePrint(F("4=B.INVITADOS, 5=LAVANDERIA, 6=B.PRINCIPAL, 7=H.PRINCIPAL"));
  consolePrint(F("Pines: 2-9"));
  consolePrint(F("Angulo CERRADO: 0, ABIERTO: 90"));
  consolePrint(F("Sistema listo"));
}

void loop() {
  delay(10);
}

void receiveEvent(int howMany) {
  char cmd[MAX_CMD_LENGTH + 1];
  int i = 0;
  
  while (Wire.available() && i < MAX_CMD_LENGTH) {
    cmd[i++] = Wire.read();
  }
  cmd[i] = '\0'; // Null-terminate the string
  
  // Clear any remaining bytes in the buffer
  while (Wire.available()) {
    Wire.read();
  }
  
  // Convert to uppercase (in-place)
  for (int j = 0; cmd[j]; j++) {
    cmd[j] = toupper(cmd[j]);
  }
  
  char* guion_ptr = strchr(cmd, '_');
  
  if (guion_ptr != NULL && guion_ptr != cmd && *(guion_ptr + 1) != '\0') {
    *guion_ptr = '\0'; // Split the string at the underscore
    int index = atoi(cmd);
    char* accion = guion_ptr + 1;
    
    char consoleBuffer[60];
    
    if (index >= 0 && index < 8) {
      if (strcmp(accion, "ABRIR") == 0) {
        servos[index].write(ABIERTO);
        estado[index] = true;
        sprintf(consoleBuffer, "Puerta %d ABIERTA [Pin %d, Angulo: 90]", index, servoPins[index]);
        consolePrint(consoleBuffer);
      }
      else if (strcmp(accion, "CERRAR") == 0) {
        servos[index].write(CERRADO);
        estado[index] = false;
        sprintf(consoleBuffer, "Puerta %d CERRADA [Pin %d, Angulo: 0]", index, servoPins[index]);
        consolePrint(consoleBuffer);
      }
      else {
        sprintf(consoleBuffer, "ERROR: Accion desconocida: %s", accion);
        consolePrint(consoleBuffer);
      }
    } else {
      sprintf(consoleBuffer, "ERROR: Indice de puerta invalido: %d (rango: 0-7)", index);
      consolePrint(consoleBuffer);
    }
  } else {
    consolePrint(F("ERROR: Formato de comando invalido"));
    consolePrint(F("Formato esperado: NUMERO_ACCION (ej: 2_ABRIR)"));
  }
}

void requestEvent() {
  for (int i = 0; i < 8; i++) {
    Wire.write(estado[i] ? '1' : '0');
  }
  consolePrint(F("Estados enviados al Master"));
}